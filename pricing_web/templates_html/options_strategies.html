{% extends 'base.html' %}
{% load static %}

{% block title %}Pricer de strategies optionnelles{% endblock %}

{% block content %}

<div class="container mt-5">
    <h1 class="text-center">Calcul des Stratégies d'Options</h1>
    
    <form id="option-form">
        <div class="mb-3">
            <label for="strategy_type" class="form-label">Type de Stratégie</label>
            <select id="strategy_type" class="form-select" required>
                <option value="straddle">Straddle</option>
                <option value="strangle">Strangle</option>
                <option value="bullspread">Bull Spread</option>
                <option value="bearspread">Bear Spread</option>
                <option value="butterflyspread">Butterfly Spread</option>
                <option value="condorspread">Condor Spread</option>
                <option value="calendarspread">Calendar Spread</option>
                <option value="collar">Collar</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="maturity" class="form-label">Échéance (en années)</label>
            <input type="number" id="maturity" class="form-control" step="0.01" required>
        </div>

        <div class="mb-3">
            <label for="strike" class="form-label">Prix d'Exercice</label>
            <input type="number" id="strike" class="form-control" required>
        </div>

        <!-- Champs supplémentaires pour certaines stratégies -->
        <div id="strangle-fields" style="display: none;">
            <div class="mb-3">
                <label for="strike_put" class="form-label">Prix d'Exercice du Put</label>
                <input type="number" id="strike_put" class="form-control">
            </div>
        </div>

        <div id="bullspread-fields" style="display: none;">
            <div class="mb-3">
                <label for="strike_high" class="form-label">Prix d'Exercice du Call Vendu</label>
                <input type="number" id="strike_high" class="form-control">
            </div>
        </div>

        <div id="butterflyspread-fields" style="display: none;">
            <div class="mb-3">
                <label for="strike_mid" class="form-label">Prix d'Exercice des Options Vendues</label>
                <input type="number" id="strike_mid" class="form-control">
            </div>
        </div>

        <div id="condorspread-fields" style="display: none;">
            <div class="mb-3">
                <label for="strike_mid1" class="form-label">Premier Prix d'Exercice du Call Vendu</label>
                <input type="number" id="strike_mid1" class="form-control">
            </div>
            <div class="mb-3">
                <label for="strike_mid2" class="form-label">Deuxième Prix d'Exercice du Call Vendu</label>
                <input type="number" id="strike_mid2" class="form-control">
            </div>
        </div>

        <div id="calendarspread-fields" style="display: none;">
            <div class="mb-3">
                <label for="maturity_far" class="form-label">Échéance de l'Option Lointaine</label>
                <input type="number" id="maturity_far" class="form-control">
            </div>
        </div>

        <div id="collar-fields" style="display: none;">
            <div class="mb-3">
                <label for="strike_put" class="form-label">Prix d'Exercice du Put</label>
                <input type="number" id="strike_put" class="form-control">
            </div>
        </div>

        <button type="submit" class="btn btn-primary">Calculer</button>
    </form>

    <div class="mt-4 text-center">
        <h2>Résultats de la Stratégie</h2>

        <!-- Affichage du prix calculé -->
        <p><strong>Prix Calculé :</strong></p>
        <p id="option-price" class="fs-2 fw-bold">-</p>

        <!-- Tableau des Grecs -->
        <h3>Grecs de l'Option</h3>
        <table class="table table-bordered" id="greeks-table" style="margin: 0 auto; width: 50%; display: none;">
            <thead>
                <tr>
                    <th>Grecs</th>
                    <th>Valeur</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>Delta</td><td id="delta">-</td></tr>
                <tr><td>Gamma</td><td id="gamma">-</td></tr>
                <tr><td>Vega</td><td id="vega">-</td></tr>
                <tr><td>Theta</td><td id="theta">-</td></tr>
                <tr><td>Rho</td><td id="rho">-</td></tr>
            </tbody>
        </table>

        <!-- Graphique du Payoff -->
        <h3>Graphique du Payoff</h3>
        <div align="center">
            <img id="payoff-graph" src="" alt="Graphique du Payoff" class="img-fluid" style="display: none;">
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.getElementById('strategy_type').addEventListener('change', function() {
        const strategyType = this.value;

        // Cacher tous les champs supplémentaires
        document.querySelectorAll('[id$="-fields"]').forEach(el => el.style.display = 'none');

        // Afficher les champs appropriés en fonction de la stratégie sélectionnée
        if (strategyType === 'strangle') {
            document.getElementById('strangle-fields').style.display = 'block';
        } else if (strategyType === 'bullspread') {
            document.getElementById('bullspread-fields').style.display = 'block';
        } else if (strategyType === 'butterflyspread') {
            document.getElementById('butterflyspread-fields').style.display = 'block';
        } else if (strategyType === 'condorspread') {
            document.getElementById('condorspread-fields').style.display = 'block';
        } else if (strategyType === 'calendarspread') {
            document.getElementById('calendarspread-fields').style.display = 'block';
        } else if (strategyType === 'collar') {
            document.getElementById('collar-fields').style.display = 'block';
        }
    });

    document.getElementById('option-form').addEventListener('submit', function (event) {
        event.preventDefault();

        let formData = new FormData(this);
        let queryString = new URLSearchParams(formData).toString();

        fetch('http://127.0.0.1:8000/calculate_strategy_price?' + queryString)
            .then(response => response.json())
            .then(data => {
                console.log(data);

                // Mettre à jour le prix de l'option
                document.getElementById('option-price').textContent = data.price;

                // Mettre à jour les Grecs dans le tableau
                document.getElementById('delta').textContent = data.greeks.Delta.toFixed(4);
                document.getElementById('gamma').textContent = data.greeks.Gamma.toFixed(4);
                document.getElementById('vega').textContent = data.greeks.Vega.toFixed(4);
                document.getElementById('theta').textContent = data.greeks.Theta.toFixed(4);
                document.getElementById('rho').textContent = data.greeks.Rho.toFixed(4);

                // Afficher le tableau des Grecs
                document.getElementById('greeks-table').style.display = 'table';

                // Mettre à jour l'image du payoff
                const graphElement = document.getElementById('payoff-graph');
                graphElement.src = data.payoff_graph; // Met à jour l'élément image avec l'URL du graphique
                graphElement.style.display = 'block'; // Affiche le graphique
            })
            .catch(error => console.error('Erreur requête AJAX:', error));
    });
</script>
{% endblock %}
